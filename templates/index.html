<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng D·∫´n ƒê∆∞·ªùng Th√¥ng Minh A*</title>
    
    <!-- LEAFLET CSS & FONT AWESOME -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS CHUNG */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* SIDEBAR */
        #sidebar { width: 320px; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 2000; display: flex; flex-direction: column; position: relative; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; }
        .header h2 { margin: 0; font-size: 1.2rem; }
        .content { padding: 15px; flex: 1; overflow-y: auto; }
        
        /* RESULT BOX */
        #result-box {
            background: #e8f5e9; padding: 15px; border-radius: 5px; 
            border-left: 5px solid #27ae60; margin-bottom: 15px; display: none;
        }
        #result-box p { margin: 5px 0; color: #2e7d32; font-size: 0.95rem; }
        #result-box b { font-size: 1.1rem; }

        /* INPUTS */
        .group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* BUTTONS */
        .btn-row { display: flex; gap: 5px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #3498db; } .btn-blue:hover { background: #2980b9; }
        .btn-red { background: #e74c3c; } .btn-red:hover { background: #c0392b; }
        .btn-orange { background: #f39c12; } .btn-orange:hover { background: #d35400; }
        .btn-gray { background: #95a5a6; } .btn-gray:hover { background: #7f8c8d; }

        /* MAP */
        #main { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        /* CUSTOM MARKER ICONS */
        .custom-icon {
            text-align: center;
            line-height: 32px;
        }
        .start-icon i {
            color: #2ecc71; /* Xanh l√° */
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
        }
        .end-icon i {
            color: #e74c3c; /* ƒê·ªè */
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
        }

        /* LOADING */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω...</p>
    </div>

    <div id="sidebar">
        <div class="header">
            <h2>Route Master A*</h2>
            <small>Thanh Xuan District</small>
        </div>
        
        <div class="content">
            <!-- K·∫æT QU·∫¢ -->
            <div id="result-box">
                <p><i class="fas fa-clock"></i> Th·ªùi gian: <b id="timeDisplay">--</b> ph√∫t</p>
                <p><i class="fas fa-road"></i> Qu√£ng ƒë∆∞·ªùng: <b id="distDisplay">--</b> km</p>
                <p><i class="fas fa-info-circle"></i> Ch·∫ø ƒë·ªô: <span id="modeDisplay">--</span></p>
            </div>

            <!-- FORM T√åM KI·∫æM -->
            <div class="group">
                <label>üìç ƒêi·ªÉm ƒëi / ƒêi·ªÉm ƒë·∫øn:</label>
                <input id="startPlace" placeholder="Click tr√™n b·∫£n ƒë·ªì..." readonly>
                <input id="endPlace" placeholder="Click tr√™n b·∫£n ƒë·ªì..." readonly>
                
                <label>üõµ Ph∆∞∆°ng ti·ªán & Thu·∫≠t to√°n:</label>
                <div class="btn-row">
                    <select id="vehicleSelect">
                        <option value="car">√î t√¥</option>
                        <option value="motorbike">Xe m√°y</option>
                        <option value="bicycle">Xe ƒë·∫°p</option>
                        <option value="foot">ƒêi b·ªô</option>
                    </select>
                    <select id="modeSelect">
                        <option value="fastest">Nhanh nh·∫•t (A*)</option>
                        <option value="shortest">Ng·∫Øn nh·∫•t (Dijkstra)</option>
                    </select>
                </div>
                <button class="btn-gray" onclick="clearMap()" style="width: 100%; margin-top: 5px;">X√≥a & Ch·ªçn l·∫°i</button>
            </div>

            <!-- FORM ADMIN -->
            <div class="group">
                <label>üö¶ Qu·∫£n l√Ω giao th√¥ng (Admin):</label>
                <input id="streetInput" placeholder="Nh·∫≠p t√™n ƒë∆∞·ªùng (VD: nguyen trai)...">
                <label>M·ª©c ƒë·ªô t·∫Øc:</label>
                <input type="range" id="trafficLevel" min="1" max="3" value="1">
                <div style="text-align: center; color: #e67e22; font-weight: bold;">C·∫•p ƒë·ªô: <span id="levelVal">1</span></div>
                <div class="btn-row" style="margin-top: 10px;">
                    <button class="btn-orange" onclick="changeWeight()">B√°o T·∫Øc</button>
                    <button class="btn-red" onclick="banRoute()">C·∫•m ƒê∆∞·ªùng</button>
                </div>
                <button class="btn-blue" onclick="resetGraph()" style="margin-top: 5px; width: 100%;">Reset Data</button>
            </div>
        </div>
    </div>

    <div id="main">
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([21.000, 105.820], 14); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(map);

        var points = [];
        var markers = [];
        var routeLayer = null;
        var banLayers = [];

        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // Load Boundary
        fetch('/boundary').then(r=>r.json()).then(coords => {
            if(coords.length) L.polygon(coords, {color:'#555', fillOpacity:0.05, dashArray:'5,5'}).addTo(map);
        }).catch(err => console.warn("Ch∆∞a ch·∫°y server Python:", err));

        // X·ª¨ L√ù CLICK
        map.on('click', function(e) {
            if(routeLayer || points.length >= 2) clearMap();

            points.push(e.latlng);
            
            // T·∫†O CUSTOM MARKER (M≈®I T√äN / C·ªú)
            var iconHtml, className;
            if (points.length === 1) {
                // ƒêi·ªÉm ƒëi: M≈©i t√™n ch·ªâ xu·ªëng
                iconHtml = '<i class="fas fa-map-marker-alt fa-3x"></i>';
                className = 'custom-icon start-icon';
            } else {
                // ƒêi·ªÉm ƒë·∫øn: C·ªù ƒë√≠ch
                iconHtml = '<i class="fas fa-flag-checkered fa-2x"></i>';
                className = 'custom-icon end-icon';
            }

            var customIcon = L.divIcon({
                html: iconHtml,
                className: className,
                iconSize: [32, 42],
                iconAnchor: [16, 42] // CƒÉn gi·ªØa ƒë√°y
            });
            
            var mk = L.marker(e.latlng, {icon: customIcon}).addTo(map);
            markers.push(mk);

            var coordText = e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
            if(points.length === 1) document.getElementById('startPlace').value = coordText;
            else document.getElementById('endPlace').value = coordText;

            if(points.length === 2) {
                var vehicle = document.getElementById('vehicleSelect').value;
                var mode = document.getElementById('modeSelect').value;
                
                showLoading(true);
                fetch('/find-route-by-click', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ point1: points[0], point2: points[1], vehicle: vehicle, mode: mode })
                })
                .then(r => r.json())
                .then(res => {
                    showLoading(false);
                    if(res.error) {
                        alert(res.error);
                        clearMap();
                    } else {
                        routeLayer = L.polyline(res.coords, {color: 'blue', weight: 6, opacity: 0.8}).addTo(map);
                        map.fitBounds(routeLayer.getBounds());
                        
                        document.getElementById('result-box').style.display = 'block';
                        document.getElementById('timeDisplay').innerText = res.time;
                        document.getElementById('distDisplay').innerText = res.distance;
                        document.getElementById('modeDisplay').innerText = res.mode === 'fastest' ? "Nhanh nh·∫•t" : "Ng·∫Øn nh·∫•t";
                    }
                })
                .catch(e => { showLoading(false); alert("L·ªói k·∫øt n·ªëi Server!"); console.error(e); });
            }
        });

        window.clearMap = function() {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = null;
            markers.forEach(m => map.removeLayer(m));
            markers = []; points = [];
            document.getElementById('startPlace').value = "";
            document.getElementById('endPlace').value = "";
            document.getElementById('result-box').style.display = 'none';
        }

        window.banRoute = function() {
            var s = document.getElementById('streetInput').value;
            if(!s) return alert("Nh·∫≠p t√™n ƒë∆∞·ªùng!");
            showLoading(true);
            fetch('/ban-route', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({street:s})})
            .then(r=>r.json()).then(d=>{
                showLoading(false);
                alert(d.message);
                if(d.routes) d.routes.forEach(l => banLayers.push(L.polyline(l, {color:'red', weight:4}).addTo(map)));
            });
        }

        window.changeWeight = function() {
            var s = document.getElementById('streetInput').value;
            var l = document.getElementById('trafficLevel').value;
            if(!s) return alert("Nh·∫≠p t√™n ƒë∆∞·ªùng!");
            showLoading(true);
            fetch('/change-weight', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({street:s, level:l})})
            .then(r=>r.json()).then(d=>{ showLoading(false); alert(d.message); });
        }

        window.resetGraph = function() {
            if(!confirm("Reset d·ªØ li·ªáu?")) return;
            fetch('/reset', {method:'POST'}).then(r=>r.json()).then(d=>{
                alert(d.message);
                banLayers.forEach(l => map.removeLayer(l));
                clearMap();
            });
        }

        document.getElementById('trafficLevel').oninput = function() {
            document.getElementById('levelVal').innerText = this.value;
        }
    </script>
</body>
</html>